<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SCRATCH & WIN | OFFICIAL</title>
  <style>
    :root {
      --gold: #d4af37;
      --deep-purple: #1a0033;
      --light-purple: #330066;
      --green: #008751;
      --glass: rgba(255,255,255,0.1);
      --red: #dc3545;
    }

    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background: var(--deep-purple);
      color: white;
      margin: 0;
      padding-bottom: 140px;
      user-select: none;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      background: rgba(0,0,0,0.9);
      padding: 15px;
      border-bottom: 2px solid var(--gold);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      position: relative;
    }

    .logo {
      color: var(--gold);
      margin: 0;
      font-size: 1.5rem;
    }

    .header-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .dep-btn {
      background: var(--gold);
      color: black;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 13px;
      transition: 0.2s;
    }

    .dep-btn:hover {
      opacity: 0.9;
      transform: scale(1.02);
    }

    #mute-btn {
      background: transparent;
      border: 1px solid var(--gold);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Balance Cards */
    .balance-row {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 10px;
    }

    .bal-card {
      background: var(--glass);
      padding: 12px 20px;
      border: 1px solid var(--gold);
      border-radius: 16px;
      cursor: pointer;
      min-width: 140px;
      text-align: center;
      transition: 0.3s;
    }

    .active-bal {
      background: var(--green);
      border-color: #fff;
      box-shadow: 0 0 20px rgba(0, 135, 81, 0.6);
      transform: scale(1.05);
    }

    .username-tag {
      font-size: 12px;
      color: var(--gold);
      text-align: center;
      margin: 10px 0 0;
    }

    /* Stake Selector */
    .tier-selector {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding: 15px;
      scrollbar-width: none;
    }

    .tier-selector::-webkit-scrollbar {
      display: none;
    }

    .tier-btn {
      background: var(--light-purple);
      border: 1px solid var(--gold);
      color: white;
      padding: 10px 25px;
      border-radius: 30px;
      white-space: nowrap;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }

    .tier-btn.active {
      background: var(--green);
      border-color: white;
    }

    /* Gauge */
    .gauge-section {
      margin: 10px auto;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }

    .bar-bg {
      background: #000;
      height: 18px;
      border-radius: 20px;
      border: 1px solid var(--gold);
      overflow: hidden;
    }

    #bar-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #ff416c, #00ff00);
      transition: width 0.8s ease;
    }

    #gauge-label {
      font-size: 11px;
      color: var(--gold);
      margin-top: 6px;
      font-weight: bold;
    }

    /* Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      max-width: 360px;
      margin: 20px auto;
      padding: 15px;
      background: var(--light-purple);
      border-radius: 20px;
      border: 2px solid var(--gold);
    }

    .scratch-container {
      position: relative;
      width: 100%;
      aspect-ratio: 1/1;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--gold);
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
      z-index: 2;
      touch-action: none;
      transition: opacity 0.4s;
    }

    .reveal-content {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: black;
      z-index: 1;
    }

    .reveal-content .naira-icon {
      font-size: 28px;
      font-weight: bold;
      color: var(--green);
    }

    .reveal-content .amt {
      font-weight: bold;
      font-size: 14px;
      color: #333;
    }

    .win-badge {
      color: green;
      font-size: 10px;
      margin-top: 2px;
    }

    /* Buttons */
    .btn {
      background: var(--green);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      width: 90%;
      max-width: 350px;
      margin: 10px auto;
      display: block;
      font-size: 16px;
      transition: 0.2s;
    }

    .btn-gold {
      background: var(--gold);
      color: black;
    }

    .btn:hover {
      opacity: 0.9;
      transform: scale(1.02);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Forms */
    .form-section {
      margin: 30px auto;
      padding: 25px;
      background: rgba(0,0,0,0.4);
      max-width: 380px;
      border-radius: 20px;
      border: 1px solid var(--gold);
    }

    .input-field, select {
      width: 100%;
      padding: 14px;
      margin-bottom: 15px;
      border-radius: 10px;
      border: none;
      display: block;
      box-sizing: border-box;
      background: #fff;
      color: #333;
      font-size: 14px;
    }

    /* Modals / Screens */
    .screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.98);
      z-index: 2000;
      overflow-y: auto;
      padding: 20px;
    }

    .visible {
      display: block;
    }

    .content-card {
      background: white;
      color: black;
      padding: 30px;
      border-radius: 24px;
      width: 95%;
      max-width: 380px;
      margin: 50px auto;
      text-align: center;
      border: 3px solid var(--gold);
    }

    .win-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 85%;
      max-width: 350px;
      background: white;
      color: black;
      border: 5px solid var(--gold);
      border-radius: 20px;
      z-index: 3000;
      padding: 30px 20px;
      text-align: center;
      box-shadow: 0 0 50px var(--gold);
    }

    .win-modal h1 {
      color: var(--gold);
      font-size: 42px;
      margin: 10px 0;
    }

    /* Referral Modal (reuse win-modal style) */
    #referral-modal .btn {
      margin-top: 15px;
    }

    /* Live Feed */
    #live-feed {
      background: rgba(0,0,0,0.95);
      border-top: 2px solid var(--gold);
      padding: 14px;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 1500;
      font-size: 14px;
      text-align: center;
      color: var(--gold);
    }

    /* Floating Action Buttons */
    .floating-buttons {
      position: fixed;
      bottom: 80px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1600;
    }

    .floating-btn {
      background: var(--light-purple);
      color: white;
      border: 1px solid var(--gold);
      padding: 12px 16px;
      border-radius: 30px;
      cursor: pointer;
      font-size: 13px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      transition: 0.2s;
    }

    .floating-btn:hover {
      background: var(--green);
    }

    .logout-btn {
      background: var(--red);
      border-color: white;
    }

    /* Misc */
    .hidden {
      display: none !important;
    }

    .text-gold {
      color: var(--gold);
    }

    a {
      color: var(--gold);
      text-decoration: none;
    }

    hr {
      border-color: #555;
      margin: 20px 0;
    }
  </style>
</head>
<body>

  <!-- WIN MODAL -->
  <div id="win-display" class="win-modal">
    <p>üéâ CONGRATULATIONS! üéâ</p>
    <h1>‚Ç¶<span id="win-amt-text">0</span></h1>
    <p>YOU WON!</p>
    <button class="btn" onclick="document.getElementById('win-display').style.display='none'">COLLECT</button>
  </div>

  <!-- REFERRAL MODAL -->
  <div id="referral-modal" class="win-modal" style="max-width: 420px;">
    <h3 style="color: var(--gold); margin-top: 0;">üîó YOUR REFERRAL LINK</h3>
    <p style="font-size: 14px;">Share your code and earn <strong>5% commission</strong> on every deposit they make!</p>
    <div style="background: #000; padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid var(--gold);">
      <span id="referral-code-display" style="font-size: 28px; font-weight: bold; color: var(--gold); letter-spacing: 3px;"></span>
    </div>
    <div style="display: flex; justify-content: space-around; margin: 15px 0;">
      <div>
        <div style="font-size: 12px; color: #ccc;">REFERRED</div>
        <div id="referred-count" style="font-size: 24px; color: var(--gold); font-weight: bold;">0</div>
      </div>
      <div>
        <div style="font-size: 12px; color: #ccc;">TOTAL DEPOSITS</div>
        <div id="referral-deposits" style="font-size: 24px; color: var(--gold); font-weight: bold;">‚Ç¶0</div>
      </div>
      <div>
        <div style="font-size: 12px; color: #ccc;">YOUR EARNINGS</div>
        <div id="referral-earnings" style="font-size: 24px; color: var(--gold); font-weight: bold;">‚Ç¶0</div>
      </div>
    </div>
    <button onclick="copyReferralCode()" class="btn" style="background: #008751; margin-top: 10px;">üìã COPY CODE</button>
    <button onclick="closeReferralModal()" class="btn" style="background: #333; margin-top: 10px;">CLOSE</button>
  </div>

  <!-- AUTO SCRATCH MODAL -->
  <div id="auto-modal" class="win-modal" style="max-width: 400px; display: none;">
    <h3 style="color: var(--gold);">‚ö° AUTO SCRATCH</h3>
    <p style="font-size: 14px;">Play multiple games automatically</p>

    <div style="margin: 20px 0;">
      <select id="auto-stake" class="input-field" style="background:#222; color:white;">
        <option value="150">‚Ç¶150 per game</option>
        <option value="300">‚Ç¶300 per game</option>
        <option value="500">‚Ç¶500 per game</option>
        <option value="1000">‚Ç¶1000 per game</option>
      </select>

      <select id="auto-mode" class="input-field" style="background:#222; color:white;">
        <option value="demo">Demo Mode</option>
        <option value="real">Real Mode</option>
      </select>

      <select id="auto-count" class="input-field" style="background:#222; color:white;">
        <option value="10">10 games</option>
        <option value="30">30 games</option>
        <option value="50">50 games</option>
        <option value="100">100 games</option>
        <option value="500">500 games</option>
      </select>
    </div>

    <div id="auto-preview" style="font-size: 14px; color: #ccc; margin: 10px 0;">
      Total cost: <span id="auto-total-cost">‚Ç¶1,500</span>
    </div>

    <button id="start-auto-btn" class="btn" onclick="startAutoPlay()">‚ñ∂Ô∏è START AUTO</button>
    <button class="btn" style="background:#333;" onclick="closeAutoModal()">CLOSE</button>
  </div>

  <!-- HEADER -->
  <div class="header">
    <div class="top-bar">
      <h2 class="logo">SCRATCH & WIN</h2>
      <div class="header-buttons">
        <button class="dep-btn" onclick="showReferralModal()">üîó Refer & Earn</button>
        <button class="dep-btn" onclick="openAutoModal()">‚ö° AUTO</button>
        <button class="dep-btn" onclick="document.getElementById('deposit-screen').classList.add('visible')">+ DEPOSIT</button>
        <button id="mute-btn">üîä</button>
      </div>
    </div>

    <div class="balance-row">
      <div id="real-btn" class="bal-card active-bal" onclick="setMode('real')">
        <small>REAL WALLET</small><br>
        ‚Ç¶<span id="real-bal">0</span>
      </div>
      <div id="demo-btn" class="bal-card" onclick="setMode('demo')">
        <small>DEMO BONUS</small><br>
        ‚Ç¶<span id="demo-bal">0</span>
      </div>
    </div>

    <p class="username-tag">
      Logged in as <b><span id="username"></span></b>
    </p>
  </div>

  <!-- STAKE SELECTOR -->
  <div class="tier-selector">
    <button class="tier-btn active" onclick="setTier(150, this)">‚Ç¶150 Stake</button>
    <button class="tier-btn" onclick="setTier(300, this)">‚Ç¶300 Stake</button>
    <button class="tier-btn" onclick="setTier(500, this)">‚Ç¶500 Stake</button>
    <button class="tier-btn" onclick="setTier(1000, this)">‚Ç¶1000 Stake</button>
  </div>

  <!-- GAUGE -->
  <div class="gauge-section">
    <div class="bar-bg"><div id="bar-fill"></div></div>
    <p id="gauge-label">REAL GAUGE: 0%</p>
  </div>

  <!-- SCRATCH GRID -->
  <div class="grid" id="main-grid">
    <!-- Grid cells injected by JS -->
  </div>
  <button class="btn btn-gold" onclick="initGrid()">üé≤ GET NEW CARD</button>

  <!-- WITHDRAWAL / BANK FORM -->
  <div class="form-section">
    <h3 style="color:var(--gold); margin-top:0; text-align:center;">üí∏ WITHDRAWAL</h3>

    <!-- Bank Details Form (shown first) -->
    <div id="bank-details-form">
      <p style="font-size: 13px; color: #ccc; margin-bottom: 15px;">Save your bank details (once only)</p>
      <select id="banks" class="input-field" required>
        <option value="">Select Bank...</option>
        <option>Access Bank</option><option>Opay</option><option>Palmpay</option>
        <option>Kuda</option><option>GTBank</option><option>Zenith Bank</option>
        <option>First Bank</option><option>UBA</option><option>Union Bank</option>
        <option>Fidelity Bank</option><option>Stanbic IBTC</option><option>Sterling Bank</option>
      </select>
      <input type="text" id="acc_name" class="input-field" placeholder="Account Name" required>
      <input type="text" id="acc_num" class="input-field" placeholder="Account Number (digits only)" pattern="\d+" required>
      <button class="btn" onclick="saveBankDetails()">üíæ SAVE BANK DETAILS</button>
    </div>

    <!-- Withdrawal Request Form (shown after bank details saved) -->
    <div id="withdrawal-form" style="display: none;">
      <div style="background: rgba(0,135,81,0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
        <p style="font-size: 13px; color: var(--gold); margin: 0 0 8px;"><b>Withdrawal Status:</b> <span id="withdrawal-status-text">Checking...</span></p>
        <p style="font-size: 12px; color: #ccc; margin: 5px 0;">
          ‚Ä¢ Staking: <span id="stake-req">‚Ç¶5,000</span><br>
          ‚Ä¢ Winnings: <span id="win-req">‚Ç¶3,000</span>
        </p>
      </div>

      <div id="withdrawal-unlock-message" style="background: rgba(255,193,7,0.1); border:1px solid #ffc107; padding:12px; border-radius:8px; margin-bottom:15px; display:none;">
        <p style="font-size: 12px; color: #ffc107; margin:0;">
          ‚ö†Ô∏è <b>Admin Approval Required</b><br>
          You've met the requirements! Admin will unlock withdrawals.
        </p>
      </div>

      <div id="withdrawal-ready" style="display:none;">
        <p style="font-size: 13px; color: #00ff00; margin-bottom: 10px;">‚úÖ Withdrawal unlocked by admin!</p>
        <input type="number" id="withdraw-amount" class="input-field" placeholder="Amount to withdraw (min ‚Ç¶1000)" min="1000" step="100">
        <button class="btn" onclick="submitWithdrawalRequest()">üì§ REQUEST WITHDRAWAL</button>
      </div>
    </div>
  </div>

  <!-- DEPOSIT SCREEN -->
  <div id="deposit-screen" class="screen">
    <div class="content-card">
      <h2 style="color:var(--green);">üí∞ TOP UP WALLET</h2>
      <p>Select deposit amount. Admin will approve after payment verification.</p>
      <button class="btn" onclick="showBank(1000)">‚Ç¶1,000 Deposit</button>
      <button class="btn" onclick="showBank(5000)">‚Ç¶5,000 Deposit</button>
      <button class="btn" onclick="showBank(10000)">‚Ç¶10,000 Deposit</button>
      <p onclick="closeScreens()" style="cursor:pointer; font-size:13px; color:gray; margin-top:20px;">Close</p>
    </div>
  </div>

  <!-- BANK PAYMENT SCREEN -->
  <div id="bank-screen" class="screen">
    <div class="content-card">
      <h3>üè¶ PAYMENT DESK</h3>
      <div id="bank-details" style="background:#f5f5f5; padding:15px; border-radius:10px; margin:20px 0;">
        <!-- Dynamically filled -->
      </div>
      <button class="btn" onclick="confirmPayment()">‚úÖ I HAVE PAID</button>
      <p onclick="closeScreens()" style="cursor:pointer; font-size:13px; color:gray; margin-top:20px;">Cancel</p>
    </div>
  </div>

  <!-- FLOATING HISTORY BUTTONS -->
  <div class="floating-buttons">
    <button class="floating-btn" onclick="window.location.href='deposit-history.html'">
      üì• Deposit History
    </button>
    <button class="floating-btn" onclick="window.location.href='withdrawal-history.html'">
      üì§ Withdrawal History
    </button>
    <button class="floating-btn" onclick="window.location.href='game-history.html'">
      üéÆ Game History
    </button>
    <button class="floating-btn logout-btn" onclick="logout()">
      üö™ Logout
    </button>
  </div>

  <!-- LIVE FEED -->
  <div id="live-feed">
    <span id="feed-text">Connecting...</span>
  </div>

  <script>
    // ========== CONFIGURATION ==========
    const API = window.location.origin;
    let currentUser = null;
    let state = {
      mode: 'real',
      currentStake: 150,
      stakedReal: 0,
      stakedDemo: 0,
      depositTier: null
    };

    // ========== TOKEN CHECK ==========
    (function checkToken() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'auth.html';
      }
    })();

    // ========== USER LOAD ==========
    async function loadUser() {
      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        // 1. Check if tier selected
        const tierRes = await fetch(API + '/deposit/has-tier', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const tierData = await tierRes.json();
        if (!tierData.hasTier) {
          window.location.href = 'select-tier.html';
          return;
        }

        // 2. Load user data
        const res = await fetch(API + '/user/me', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);

        currentUser = data.user;
        document.getElementById('username').innerText = currentUser.username;
        document.getElementById('real-bal').innerText = (currentUser.balance || 0).toLocaleString();
        document.getElementById('demo-bal').innerText = (currentUser.demoBalance || 0).toLocaleString();
        state.stakedReal = currentUser.totalStakedReal || 0;
        state.stakedDemo = currentUser.totalStakedDemo || 0;
        updateGauge();

        // 3. Check bank details to show withdrawal form
        if (currentUser.bankName && currentUser.accountNumber) {
          document.getElementById('bank-details-form').style.display = 'none';
          document.getElementById('withdrawal-form').style.display = 'block';
          checkWithdrawalRequirements();
        }

      } catch (err) {
        console.error('loadUser error:', err);
        alert('Session expired. Please login again.');
        logout();
      }
    }

    // ========== SWITCH BALANCE MODE ==========
    async function setMode(mode) {
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(API + '/user/switch-balance-mode', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ mode })
        });
        const data = await res.json();
        if (data.success) {
          state.mode = mode;
          document.getElementById('real-btn').className = mode === 'real' ? 'bal-card active-bal' : 'bal-card';
          document.getElementById('demo-btn').className = mode === 'demo' ? 'bal-card active-bal' : 'bal-card';
          if (mode === 'real') {
            document.getElementById('real-bal').innerText = currentUser.balance.toLocaleString();
          } else {
            document.getElementById('demo-bal').innerText = currentUser.demoBalance.toLocaleString();
          }
          updateGauge();
        } else {
          alert(data.message);
        }
      } catch (err) {
        console.error(err);
        alert('Network error');
      }
    }

    // ========== STAKE SELECTOR ==========
    function setTier(stake, btn) {
      state.currentStake = stake;
      document.querySelectorAll('.tier-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    // ========== GAUGE ==========
    function updateGauge() {
      if (!currentUser) return;
      let p, label, target, staked;
      if (state.mode === 'real') {
        const tier = currentUser.depositTier || 1000;
        const targets = { 1000: 5000, 5000: 20000, 10000: 40000 };
        target = targets[tier] || 5000;
        staked = state.stakedReal || 0;
        p = Math.min((staked / target) * 100, 99);
        label = `REAL GAUGE: ‚Ç¶${staked.toLocaleString()} / ‚Ç¶${target.toLocaleString()} (${Math.floor(p)}%)`;
      } else {
        staked = state.stakedDemo || 0;
        target = 100000;
        p = Math.min((staked / target) * 100, 99);
        label = `DEMO GAUGE: ${Math.floor(p)}%`;
      }
      document.getElementById('bar-fill').style.width = p + '%';
      document.getElementById('gauge-label').innerText = label;
    }

    // ========== GAME LOGIC ==========
    async function initGrid() {
      if (!currentUser) {
        await loadUser();
        return;
      }

      // Balance check
      if (state.mode === 'real') {
        if (!currentUser.balance || currentUser.balance < state.currentStake) {
          alert('Insufficient real balance. Please deposit or switch to demo.');
          return;
        }
      } else {
        if (!currentUser.demoBalance || currentUser.demoBalance < state.currentStake) {
          alert('Demo balance exhausted. Switch to real or deposit.');
          return;
        }
      }

      const btn = document.querySelector('.btn-gold');
      btn.disabled = true;
      btn.textContent = 'PROCESSING...';

      try {
        const token = localStorage.getItem('token');
        const res = await fetch(API + '/game/play', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            stake: state.currentStake,
            mode: state.mode
          })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);

        // Update balances
        if (state.mode === 'real') {
          currentUser.balance = data.newBalance;
          state.stakedReal = data.totalStaked || 0;
          document.getElementById('real-bal').innerText = currentUser.balance.toLocaleString();
        } else {
          currentUser.demoBalance = data.newBalance;
          state.stakedDemo = data.totalStaked || 0;
          document.getElementById('demo-bal').innerText = currentUser.demoBalance.toLocaleString();
        }

        // Render grid
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '';
        data.gridValues.forEach((val, idx) => {
          createScratchBox(grid, val, idx, data.matchingIndices || []);
        });

        // Win modal
        if (data.isWin && data.winAmount > 0) {
          triggerWin(data.winAmount);
          playWinSound();
        }

        updateGauge();

      } catch (err) {
        console.error(err);
        alert('Game error: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'GET NEW CARD';
      }
    }

    // Scratch box creator
    function createScratchBox(container, value, index, winningIndices) {
      const wrapper = document.createElement('div');
      wrapper.className = 'scratch-container';
      const isWinner = winningIndices.includes(index);
      if (isWinner) {
        wrapper.style.border = '2px solid #00ff00';
        wrapper.style.boxShadow = '0 0 10px #00ff00';
      }
      wrapper.innerHTML = `
        <div class="reveal-content">
          <div class="naira-icon">‚Ç¶</div>
          <div class="amt">‚Ç¶${value}</div>
          ${isWinner ? '<div class="win-badge">WIN!</div>' : ''}
        </div>
        <canvas></canvas>
      `;

      const canvas = wrapper.querySelector('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 110;
      canvas.height = 110;
      ctx.fillStyle = '#888';
      ctx.fillRect(0, 0, 110, 110);
      ctx.fillStyle = '#d4af37';
      ctx.font = 'bold 10px Arial';
      ctx.fillText('SCRATCH', 20, 55);
      ctx.fillText('OR TAP', 30, 70);

      let isDrawing = false, moved = false;
      const start = () => { isDrawing = true; moved = false; };
      const end = () => {
        isDrawing = false;
        if (!moved) {
          canvas.style.opacity = '0';
          setTimeout(() => canvas.remove(), 400);
        }
      };
      const scratch = (e) => {
        if (!isDrawing) return;
        moved = true;
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || (e.touches?.[0]?.clientX)) - rect.left;
        const y = (e.clientY || (e.touches?.[0]?.clientY)) - rect.top;
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(x, y, 18, 0, Math.PI * 2);
        ctx.fill();
      };

      canvas.addEventListener('mousedown', start);
      canvas.addEventListener('touchstart', start);
      window.addEventListener('mouseup', end);
      window.addEventListener('touchend', end);
      canvas.addEventListener('mousemove', scratch);
      canvas.addEventListener('touchmove', scratch, { passive: false });

      container.appendChild(wrapper);
    }

    // Win effects
    function playWinSound() {
      const sound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3');
      sound.volume = 0.5;
      sound.play().catch(e => {});
    }

    function triggerWin(amount) {
      setTimeout(() => {
        document.getElementById('win-amt-text').innerText = amount.toLocaleString();
        document.getElementById('win-display').style.display = 'block';
        if (state.mode === 'real') {
          currentUser.balance += amount;
          document.getElementById('real-bal').innerText = currentUser.balance.toLocaleString();
        } else {
          currentUser.demoBalance += amount;
          document.getElementById('demo-bal').innerText = currentUser.demoBalance.toLocaleString();
        }
      }, 3000);
    }

    // ========== WITHDRAWAL ==========
    async function saveBankDetails() {
      const bankName = document.getElementById('banks').value;
      const accountName = document.getElementById('acc_name').value.trim();
      const accountNumber = document.getElementById('acc_num').value.trim();
      if (!bankName || !accountName || !accountNumber) {
        alert('Please fill all fields');
        return;
      }
      if (!/^\d+$/.test(accountNumber)) {
        alert('Account number must be digits only');
        return;
      }
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(API + '/user/save-bank-details', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ bankName, accountName, accountNumber })
        });
        const data = await res.json();
        if (data.success) {
          alert('‚úÖ Bank details saved!');
          document.getElementById('bank-details-form').style.display = 'none';
          document.getElementById('withdrawal-form').style.display = 'block';
          checkWithdrawalRequirements();
        } else {
          alert(data.message);
        }
      } catch (err) {
        console.error(err);
        alert('Network error');
      }
    }

    async function checkWithdrawalRequirements() {
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(API + '/withdrawal/requirements', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.success) {
          const reqs = data.requirements;
          document.getElementById('stake-req').innerHTML = `‚Ç¶${reqs.stakeTarget.toLocaleString()}`;
          document.getElementById('win-req').innerHTML = `‚Ç¶${reqs.winTarget.toLocaleString()}`;
          if (data.progress.bothRequirementsMet) {
            if (data.adminUnlocked) {
              document.getElementById('withdrawal-status-text').innerHTML = '‚úÖ READY TO WITHDRAW';
              document.getElementById('withdrawal-unlock-message').style.display = 'none';
              document.getElementById('withdrawal-ready').style.display = 'block';
            } else {
              document.getElementById('withdrawal-status-text').innerHTML = '‚è≥ WAITING FOR ADMIN UNLOCK';
              document.getElementById('withdrawal-unlock-message').style.display = 'block';
              document.getElementById('withdrawal-ready').style.display = 'none';
            }
          } else {
            document.getElementById('withdrawal-status-text').innerHTML = `Requirements: ${data.progress.stakeProgress}% staked, ${data.progress.winProgress}% won`;
            document.getElementById('withdrawal-unlock-message').style.display = 'none';
            document.getElementById('withdrawal-ready').style.display = 'none';
          }
        }
      } catch (err) {
        console.error(err);
      }
    }

    async function submitWithdrawalRequest() {
      const amount = document.getElementById('withdraw-amount').value.trim();
      if (!amount || parseFloat(amount) < 1000) {
        alert('Minimum withdrawal is ‚Ç¶1,000');
        return;
      }
      if (parseFloat(amount) > currentUser.balance) {
        alert('Amount exceeds your balance');
        return;
      }
      if (!confirm(`Request withdrawal of ‚Ç¶${parseFloat(amount).toLocaleString()}?`)) return;
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(API + '/withdrawal/request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ amount })
        });
        const data = await res.json();
        if (data.success) {
          alert('‚úÖ Withdrawal request submitted!\nAdmin will review.');
          document.getElementById('withdraw-amount').value = '';
        } else {
          alert(data.message);
        }
      } catch (err) {
        console.error(err);
        alert('Network error');
      }
    }

    // ========== DEPOSIT ==========
    function showBank(amount) {
      state.depositTier = amount;
      closeScreens();
      const bankScreen = document.getElementById('bank-screen');
      const bankDetails = document.getElementById('bank-details');
      bankDetails.innerHTML = `
        <p style="margin:0 0 10px; font-weight:bold;">Transfer ‚Ç¶${amount.toLocaleString()} to:</p>
        <p style="background:#000; color:#d4af37; padding:12px; border-radius:8px;">
          <b>KUDA BANK<br>2022675714<br>IYANDA ISREAL</b>
        </p>
        <p style="font-size:13px; margin-top:15px;">After payment, click "I HAVE PAID". Admin will verify.</p>
      `;
      bankScreen.classList.add('visible');
    }

    async function confirmPayment() {
      const amount = state.depositTier;
      if (!amount) {
        alert('Please select a deposit amount');
        return;
      }
      const token = localStorage.getItem('token');
      const btn = document.querySelector('#bank-screen .btn');
      btn.disabled = true;
      btn.textContent = 'PROCESSING...';
      try {
        const res = await fetch(API + '/deposit/request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            amount,
            paymentProof: 'Bank Transfer - Awaiting verification'
          })
        });
        const data = await res.json();
        if (data.success) {
          alert(`‚úÖ Deposit request submitted!\nAmount: ‚Ç¶${amount.toLocaleString()}\nAdmin will approve.`);
          closeScreens();
          loadUser();
        } else {
          alert(data.message);
        }
      } catch (err) {
        console.error(err);
        alert('Network error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'I HAVE PAID';
      }
    }

    // ========== REFERRAL ==========
    async function showReferralModal() {
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(API + '/user/referral-info', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('referral-code-display').innerText = data.referralCode || '‚Äî';
          document.getElementById('referred-count').innerText = data.totalReferred;
          document.getElementById('referral-deposits').innerText = '‚Ç¶' + (data.totalDepositsFromReferrals || 0).toLocaleString();
          document.getElementById('referral-earnings').innerText = '‚Ç¶' + (data.totalEarnings || 0).toLocaleString();
          document.getElementById('referral-modal').style.display = 'block';
        }
      } catch (err) {
        console.error(err);
        alert('Could not load referral info');
      }
    }

    function closeReferralModal() {
      document.getElementById('referral-modal').style.display = 'none';
    }

    function copyReferralCode() {
      const code = document.getElementById('referral-code-display').innerText;
      navigator.clipboard.writeText(code);
      alert('‚úÖ Referral code copied!');
    }

    // ========== AUTO SCRATCH ==========
    function openAutoModal() {
      updateAutoTotal();
      document.getElementById('auto-modal').style.display = 'block';
    }

    function closeAutoModal() {
      document.getElementById('auto-modal').style.display = 'none';
    }

    function updateAutoTotal() {
      const stake = parseInt(document.getElementById('auto-stake').value);
      const count = parseInt(document.getElementById('auto-count').value);
      const total = stake * count;
      document.getElementById('auto-total-cost').innerText = '‚Ç¶' + total.toLocaleString();
    }

    async function startAutoPlay() {
      const stake = parseInt(document.getElementById('auto-stake').value);
      const mode = document.getElementById('auto-mode').value;
      const count = parseInt(document.getElementById('auto-count').value);
      const token = localStorage.getItem('token');

      const btn = document.getElementById('start-auto-btn');
      btn.disabled = true;
      btn.textContent = 'PROCESSING...';

      try {
        const res = await fetch(API + '/game/auto-play', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ stake, mode, count })
        });
        const data = await res.json();

        if (data.success) {
          alert(`‚úÖ ${data.message}\nNew balance: ‚Ç¶${data.newBalance.toLocaleString()}`);
          // Update balance on screen
          if (mode === 'real') {
            document.getElementById('real-bal').innerText = data.newBalance.toLocaleString();
            if (currentUser) currentUser.balance = data.newBalance;
          } else {
            document.getElementById('demo-bal').innerText = data.newBalance.toLocaleString();
            if (currentUser) currentUser.demoBalance = data.newBalance;
          }
          closeAutoModal();
          // Show the last game grid
          if (data.games && data.games.length > 0) {
            const lastGame = data.games[data.games.length - 1];
            renderGridFromGame(lastGame);
          }
        } else {
          alert('Auto-play failed: ' + data.message);
        }
      } catch (err) {
        console.error(err);
        alert('Network error during auto-play');
      } finally {
        btn.disabled = false;
        btn.textContent = '‚ñ∂Ô∏è START AUTO';
      }
    }

    // Helper to render grid from game object
    function renderGridFromGame(game) {
      const grid = document.getElementById('main-grid');
      grid.innerHTML = '';
      game.gridValues.forEach((val, idx) => {
        createScratchBox(grid, val, idx, game.matchingIndices || []);
      });
    }

    // ========== SCREEN UTILS ==========
    function closeScreens() {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('visible'));
    }

    // ========== LOGOUT ==========
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('adminToken');
      window.location.href = 'auth.html';
    }

    // ========== LIVE FEED ==========
    setInterval(() => {
      const names = ['Efe', 'Tobi', 'Sade', 'Uche', 'Bisi', 'Musa'];
      const amounts = [5000, 12000, 8500, 25000, 18000, 30000];
      const name = names[Math.floor(Math.random() * names.length)];
      const amt = amounts[Math.floor(Math.random() * amounts.length)];
      document.getElementById('feed-text').innerHTML = `üî• ${name} just withdrew ‚Ç¶${amt.toLocaleString()}!`;
    }, 8000);

    // ========== AUDIO ==========
    (function initAudio() {
      const isMuted = localStorage.getItem('musicMuted') === 'true';
      const btn = document.getElementById('mute-btn');
      btn.innerHTML = isMuted ? 'üîá' : 'üîä';
      btn.style.color = isMuted ? '#888' : '#fff';

      let audio;
      try {
        audio = new Audio('https://commondatastorage.googleapis.com/codeskulptor-assets/Epoq-Lepidoptera.ogg');
        audio.loop = true;
        audio.volume = 0.4;
        audio.muted = isMuted;
        audio.load();

        const playPromise = audio.play();
        if (playPromise !== undefined) {
          playPromise.catch(() => {
            // Autoplay blocked ‚Äì will start on first click
          });
        }
      } catch (e) {
        console.log('Audio init failed', e);
      }

      window.toggleMusic = function() {
        const newMuted = !audio.muted;
        audio.muted = newMuted;
        localStorage.setItem('musicMuted', newMuted);
        btn.innerHTML = newMuted ? 'üîá' : 'üîä';
        btn.style.color = newMuted ? '#888' : '#fff';
        if (!newMuted && audio.paused) {
          audio.play().catch(e => {});
        }
      };

      btn.onclick = window.toggleMusic;

      // Start on first click
      document.addEventListener('click', function startAudio() {
        if (!audio.muted && audio.paused) {
          audio.play().catch(() => {});
        }
        document.removeEventListener('click', startAudio);
      }, { once: true });
    })();

    // ========== EVENT LISTENERS FOR AUTO MODAL ==========
    document.addEventListener('DOMContentLoaded', function() {
      const stakeSelect = document.getElementById('auto-stake');
      const countSelect = document.getElementById('auto-count');
      if (stakeSelect) stakeSelect.addEventListener('change', updateAutoTotal);
      if (countSelect) countSelect.addEventListener('change', updateAutoTotal);
    });

    // ========== PAGE LOAD ==========
    window.onload = async function() {
      await loadUser();
      // Default mode: real if balance >= stake, else demo
      if (currentUser && currentUser.balance && currentUser.balance >= 150) {
        setMode('real');
      } else {
        setMode('demo');
      }
    };
  </script>
</body>
</html>