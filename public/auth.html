<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login | Scratch & Win</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      background: #1a0033;
      color: white;
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      padding: 20px;
    }

    .box {
      background: #0a0a0a;
      padding: 30px 25px;
      border-radius: 16px;
      width: 100%;
      max-width: 360px;
      text-align: center;
      border: 2px solid #d4af37;
      box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
    }

    .box h3 {
      margin-bottom: 20px;
      color: #d4af37;
      font-size: 24px;
      letter-spacing: 1px;
    }

    input {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border-radius: 8px;
      border: none;
      outline: none;
      font-size: 14px;
      background: #222;
      color: white;
      border: 1px solid #444;
      transition: border 0.2s;
    }

    input:focus {
      border-color: #d4af37;
    }

    input::placeholder {
      color: #aaa;
    }

    button {
      width: 100%;
      padding: 14px;
      margin-top: 20px;
      border-radius: 8px;
      border: none;
      background: #008751;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.2s;
    }

    button:hover {
      background: #00a86b;
    }

    .link {
      margin-top: 18px;
      font-size: 13px;
      cursor: pointer;
      color: #d4af37;
      text-decoration: underline;
    }

    .link:hover {
      color: #ffd700;
    }

    .hidden {
      display: none;
    }

    .referral-note {
      font-size: 11px;
      color: #aaa;
      margin-top: -5px;
      margin-bottom: 5px;
      text-align: left;
    }

    #mute-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: transparent;
      border: 1px solid #d4af37;
      color: white;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>

  <button id="mute-btn" title="Toggle Music">üîä</button>

  <div class="box">
    <h3 id="title">üîê LOGIN</h3>

    <!-- Phone field (hidden by default, shown on register) -->
    <input type="tel" id="phone" class="hidden" placeholder="Phone Number">

    <!-- Username & Password -->
    <input type="text" id="username" placeholder="Username" autocomplete="username">
    <input type="password" id="password" placeholder="Password" autocomplete="current-password">

    <!-- Referral field (hidden by default, shown on register) -->
    <div id="referral-container" class="hidden">
      <input type="text" id="referral" placeholder="Referral Code (optional)">
      <div class="referral-note">Have a referral code? Enter it here</div>
    </div>

    <button id="main-action-btn" onclick="submit()">LOGIN</button>

    <div class="link" onclick="toggle()">Create new account</div>
  </div>

  <script>
    const API = window.location.origin;
    let isRegister = false;

    // Toggle between Login and Register
    function toggle() {
      isRegister = !isRegister;
      
      // Update title and button text
      document.getElementById("title").innerText = isRegister ? "üìù REGISTER" : "üîê LOGIN";
      document.getElementById("main-action-btn").innerText = isRegister ? "REGISTER" : "LOGIN";
      
      // Show/hide phone field
      const phoneField = document.getElementById("phone");
      phoneField.classList.toggle("hidden", !isRegister);
      
      // Show/hide referral field
      const referralContainer = document.getElementById("referral-container");
      referralContainer.classList.toggle("hidden", !isRegister);
    }

    // Main submit handler
    async function submit() {
      console.log("Submit clicked, isRegister =", isRegister);

      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      
      if (!username || !password) {
        alert("Username and password are required");
        return;
      }

      let payload;
      const endpoint = isRegister ? "/auth/register" : "/auth/login";

      if (isRegister) {
        const phone = document.getElementById("phone").value.trim();
        if (!phone) {
          alert("Phone number is required for registration");
          return;
        }
        const referralCode = document.getElementById("referral").value.trim() || null;
        payload = { phone, username, password, referralCode };
      } else {
        payload = { username, password };
      }

      console.log("Sending to", endpoint, payload);

      try {
        const res = await fetch(API + endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (!res.ok || !data.success) {
          alert(data.message || "Authentication failed");
          return;
        }

        // Save token and redirect
        if (data.token) {
          localStorage.setItem("token", data.token);
          console.log("‚úÖ Login successful, redirecting...");

          // Check if user already selected a tier
          setTimeout(async () => {
            try {
              const tierCheck = await fetch(API + "/deposit/has-tier", {
                headers: { "Authorization": `Bearer ${data.token}` }
              });
              const tierData = await tierCheck.json();
              
              if (tierData.hasTier) {
                window.location.href = "game.html";
              } else {
                window.location.href = "select-tier.html";
              }
            } catch (error) {
              console.warn("Tier check failed, defaulting to tier selection", error);
              window.location.href = "select-tier.html";
            }
          }, 100);
        } else {
          alert("No token received. Please try again.");
        }
      } catch (err) {
        console.error("Network error:", err);
        alert("Network error. Please check your connection.");
      }
    }

    // ---------- AUDIO CONTROLLER ----------
    (function initAudio() {
      console.log('üéµ Setting up audio...');
      const isMuted = localStorage.getItem('musicMuted') === 'true';
      
      // Create audio element
      const audio = new Audio('https://commondatastorage.googleapis.com/codeskulptor-assets/Epoq-Lepidoptera.ogg');
      audio.loop = true;
      audio.volume = 0.3;
      audio.muted = isMuted;
      audio.load();

      // Mute button
      const btn = document.getElementById('mute-btn');
      if (btn) {
        btn.innerHTML = isMuted ? 'üîá' : 'üîä';
        btn.style.color = isMuted ? '#888' : '#fff';
        btn.onclick = function(e) {
          e.preventDefault();
          const newMuted = !audio.muted;
          audio.muted = newMuted;
          localStorage.setItem('musicMuted', newMuted);
          btn.innerHTML = newMuted ? 'üîá' : 'üîä';
          btn.style.color = newMuted ? '#888' : '#fff';
          
          if (!newMuted && audio.paused) {
            audio.play().catch(e => console.log('Play on unmute failed:', e));
          }
        };
      }

      // Try to autoplay after user interaction
      const startAudio = () => {
        if (!audio.muted && audio.paused) {
          audio.play().catch(e => console.log('Autoplay blocked, waiting for click'));
        }
      };

      // Start on any click/touch
      document.addEventListener('click', startAudio, { once: true });
      document.addEventListener('touchstart', startAudio, { once: true });

      // Also try after 2 seconds (some browsers allow it)
      setTimeout(startAudio, 2000);
    })();
  </script>
</body>
</html>