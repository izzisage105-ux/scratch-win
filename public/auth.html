<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login | Scratch Game</title>
  <style>
  * {
    box-sizing: border-box;
  }

  body {
    background: #1a0033;
    color: white;
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }

  .box {
    background: #000;
    padding: 25px;
    border-radius: 12px;
    width: 320px;
    text-align: center;
  }

  .box h3 {
    margin-bottom: 15px;
  }

  input {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border-radius: 6px;
    border: none;
    outline: none;
    font-size: 14px;
  }

  button {
    width: 100%;
    padding: 12px;
    margin-top: 12px;
    border-radius: 6px;
    border: none;
    background: #008751;
    color: white;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
  }

  .link {
    margin-top: 12px;
    font-size: 12px;
    cursor: pointer;
    color: #ccc;
  }
  </style>
</head>
<body>

<div class="box">
  <h3 id="title">LOGIN</h3>

  <input id="phone" placeholder="Phone Number" style="display:none">
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">

  <button onclick="submit()">LOGIN</button>

  <div class="link" onclick="toggle()">Create account</div>
</div>

<input id="referral" placeholder="Referral Code (optional)">

<script>
const API = window.location.origin;
let isRegister = false;

function toggle() {
  isRegister = !isRegister;
  document.getElementById("title").innerText = isRegister ? "REGISTER" : "LOGIN";
  document.querySelector("button").innerText = isRegister ? "REGISTER" : "LOGIN";
  document.getElementById("phone").style.display = isRegister ? "block" : "none";
}

async function submit() {
  console.log("Submit button clicked");
  
  try {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    const phone = document.getElementById("phone").value.trim();

    console.log("Username:", username, "Password:", password);
    
    const endpoint = isRegister ? "/auth/register" : "/auth/login";
    console.log("API Endpoint:", API + endpoint);

    const payload = isRegister
  ? { 
      phone, 
      username, 
      password,
      referralCode: document.getElementById('referral').value.trim() || null
    }
  : { username, password };

    console.log("Sending payload:", payload);

    const res = await fetch(API + endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    console.log("Response status:", res.status);
    console.log("Response headers:", res.headers);

    const data = await res.json();
    console.log("Response data:", data);

    if (!res.ok) {
      alert(data.message || "Action failed. Check console.");
      return;
    }

    // ðŸ”‘ LOGIN SUCCESS
    if (data.token) {
      console.log("âœ… Token received");
      localStorage.setItem("token", data.token);
      
      // Check if user already selected tier
      setTimeout(async () => {
        try {
          const checkResponse = await fetch(API + "/deposit/has-tier", {
            headers: { 
              "Authorization": `Bearer ${data.token}`,
              "Content-Type": "application/json"
            }
          });
          
          const checkData = await checkResponse.json();
          
          if (checkData.hasTier) {
            window.location.href = "game.html";
          } else {
            window.location.href = "select-tier.html";
          }
        } catch (error) {
          console.error("Check tier error:", error);
          window.location.href = "select-tier.html"; // Default to tier selection
        }
      }, 100);
    } else {
      console.error("No token in response:", data);
      alert("No token received. Check console.");
    }

  } catch (err) {
    console.error("Login error:", err);
    alert("Login failed: " + err.message);
  }
} // <-- THIS WAS MISSING - CLOSING BRACE FOR submit() FUNCTION
</script>
<script>
// Audio for login/register pages
(function() {
    console.log('ðŸŽµ Setting up page audio...');
    
    // Check mute preference
    const isMuted = localStorage.getItem('musicMuted') === 'true';
    
    // Create audio element with WORKING OGG file
    const audio = new Audio('https://commondatastorage.googleapis.com/codeskulptor-assets/Epoq-Lepidoptera.ogg');
    audio.loop = true;
    audio.volume = 0.3;
    audio.muted = isMuted;
    audio.load();
    
    // Update button if exists
    const btn = document.getElementById('mute-btn');
    if (btn) {
        btn.innerHTML = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
        btn.style.color = isMuted ? '#888' : '#fff';
        btn.onclick = function() {
            const newMuted = !isMuted;
            localStorage.setItem('musicMuted', newMuted);
            location.reload();
        };
    }
    
    // Start on ANY click
    const startOnClick = () => {
        if (!isMuted && audio.paused) {
            audio.play().then(() => {
                console.log('âœ… Page music started');
            }).catch(e => {
                console.log('Page audio failed:', e.message);
            });
        }
    };
    
    document.addEventListener('click', startOnClick);
    document.addEventListener('touchstart', startOnClick);
    
    // Also try auto-start
    setTimeout(() => {
        if (!isMuted && audio.paused) {
            audio.play().catch(e => {
                console.log('Auto-start failed, waiting for click');
            });
        }
    }, 1500);
})();
</script>

</body>
</html>